{% extends 'base.html' %}

{% block title %}Teacher Dashboard - CEMS{% endblock %}

{% block topbar %}
<div class="brand">
    <span class="brand-mark">C</span>
    <div class="brand-text">
        <strong>CEMS</strong>
        <small>Teacher workspace</small>
    </div>
</div>
<div class="top-actions">
    <div class="status-dot online"></div>
    <span class="status-label">Logged in as {{ request.user.username }} | {{ teacher.employee_code|default:"N/A" }}</span>
    <div class="chip">Teacher</div>
    <a class="btn ghost" href="{% url 'accounts:logout' %}">Logout</a>
</div>
{% endblock %}

{% block sidebar %}
<div class="sidebar-group">
    <p class="sidebar-label">Teacher</p>
    <nav class="menu">
        <a href="#overview" class="menu-link active">Overview</a>
        <a href="#classes" class="menu-link">Classes</a>
        <a href="#exams" class="menu-link">Exams</a>
        <a href="#admit" class="menu-link">Admission</a>
    </nav>
</div>
<div class="sidebar-group muted">
    <p class="sidebar-label">Limits</p>
    <div class="pill-list">
        <span class="pill">Assigned classes only</span>
        <span class="pill">No student creation</span>
        <span class="pill">Own exams only</span>
    </div>
</div>
{% endblock %}

{% block content %}
<style>
    .actions-wrap { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; }
    .stats-wrap { display: flex; gap: 0.35rem; flex-wrap: wrap; align-items: center; }
    .inline-form-row { display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: flex-end; }
    .inline-form-row label { display: flex; flex-direction: column; gap: 0.25rem; min-width: 200px; margin: 0; }
    .inline-form-row .grow { flex: 1 1 240px; }
    .inline-actions { display: flex; flex-direction: column; gap: 0.2rem; }
</style>

{% if messages %}
<div class="alert-stack">
    {% for message in messages %}
        <div class="alert {% if message.tags %}{{ message.tags }}{% endif %}">{{ message }}</div>
    {% endfor %}
</div>
{% endif %}

<section class="section hero" id="overview">
    <div>
        <p class="eyebrow">Welcome back, {{ request.user.first_name|default:request.user.username }}</p>
        <h1 class="hero-title">A clean workspace for your classes, students, and exams.</h1>
        <p class="muted">Navigate by cards below—each action opens a focused page so you never get lost. Employee ID: {{ teacher.employee_code|default:"N/A" }}</p>
    </div>
    <div class="hero-stats">
        <div class="metric">
            <p class="stat-label">Classes</p>
            <p class="stat-value">{{ class_count }}</p>
            <span class="tag success">Assigned</span>
        </div>
        <div class="metric">
            <p class="stat-label">Subjects</p>
            <p class="stat-value">{{ subject_count }}</p>
            <span class="tag accent">Mapped</span>
        </div>
        <div class="metric">
            <p class="stat-label">Exams</p>
            <p class="stat-value">{{ teacher_exams|length }}</p>
            <span class="tag muted">Owned</span>
        </div>
    </div>
</section>

<section class="section" id="classes">
    <div class="section-header">
        <div>
            <p class="eyebrow">Assigned classes</p>
            <h2>Quick actions per class.</h2>
        </div>
        <div class="hint">Students and subjects open in focused pages.</div>
    </div>
    <div class="table-scroll card">
        <table class="table compact">
            <thead>
                <tr>
                    <th>Class</th>
                    <th>Students</th>
                    <th>Subjects</th>
                    <th>Year</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for row in class_rows %}
                {% with cls=row.class_level %}
                <tr>
                    <td>{{ cls.name }}{% if cls.section %} - {{ cls.section }}{% endif %}</td>
                    <td>{{ row.student_count|default:"0" }}</td>
                    <td>
                        {% if row.subjects %}
                            {% for subj in row.subjects %}{{ subj.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
                        {% else %}
                            <span class="muted">No subjects yet</span>
                        {% endif %}
                    </td>
                    <td>{{ cls.academic_year }}</td>
                    <td class="actions">
                        <div class="actions-wrap">
                            <a class="btn ghost" href="{% url 'academics:teacher_class_students' cls.id %}">Students</a>
                            <a class="btn secondary" href="{% url 'academics:teacher_class_subjects' cls.id %}">Subjects</a>
                        </div>
                    </td>
                </tr>
                {% endwith %}
                {% empty %}
                <tr><td colspan="5" class="muted">No class assignments yet.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>

<section class="section" id="exams">
    <div class="section-header">
        <div>
            <p class="eyebrow">Exams</p>
            <h2>See all exams you own with quick stats.</h2>
        </div>
        <div class="actions">
            <a class="btn primary" href="{% url 'exams:teacher_exam_create' %}">Create exam</a>
        </div>
    </div>
    <div class="table-scroll card">
        <table class="table compact">
            <thead>
                <tr>
                    <th>Exam</th>
                    <th>Class</th>
                    <th>Date</th>
                    <th>Marks</th>
                    <th>Stats</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for exam in teacher_exams %}
                <tr>
                    <td>{{ exam.title }}</td>
                    <td>{{ exam.class_level }}</td>
                    <td>{{ exam.exam_date|default:"—" }}</td>
                    <td>{{ exam.max_marks }}</td>
                    <td>
                        <div class="stats-wrap">
                            <span class="pill">Taken {{ exam.result_count|default:0 }}</span>
                            <span class="pill">High {{ exam.highest|floatformat:2|default:"—" }}</span>
                            <span class="pill">Low {{ exam.lowest|floatformat:2|default:"—" }}</span>
                            <span class="pill">Avg {{ exam.average|floatformat:2|default:"—" }}</span>
                        </div>
                    </td>
                    <td class="actions">
                        <div class="actions-wrap">
                            <a class="btn ghost" href="{% url 'exams:teacher_exam_manage' exam.id %}">Manage</a>
                            <a class="btn secondary" href="{% url 'exams:teacher_exam_results' exam.id %}">Results</a>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="6" class="muted">No exams yet. Create one above.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>

<section class="section" id="admit">
    <div class="section-header">
        <div>
            <p class="eyebrow">Student admission</p>
            <h2>Admit an existing student to one of your classes.</h2>
        </div>
        <div class="hint">Search by student ID or name; only your classes are listed.</div>
    </div>
    <div class="card">
        {% if assigned_classes %}
        <form method="post" class="inline-form-row">
            {% csrf_token %}
            <input type="hidden" name="action" value="enroll_student">
            <label>
                <span class="label">Class (assigned)</span>
                <select name="class_id" required>
                    {% for cls in assigned_classes %}
                    <option value="{{ cls.id }}">{{ cls.name }}{% if cls.section %} - {{ cls.section }}{% endif %} ({{ cls.academic_year }})</option>
                    {% endfor %}
                </select>
            </label>
            <label class="grow">
                <span class="label">Student ID or name</span>
                <input type="text" name="student_identifier" placeholder="225002001 or username" required>
            </label>
            <div class="inline-actions">
                <button class="btn primary" type="submit">Admit to class</button>
                <span class="helper">Search by student_id, username, or name.</span>
            </div>
        </form>
        {% else %}
        <div class="empty-state">
            <p>No assigned classes available yet.</p>
        </div>
        {% endif %}
    </div>
</section>
{% endblock %}
